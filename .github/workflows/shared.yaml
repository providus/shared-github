name: Build & Deploy

on:
  workflow_call:
    inputs:
      cr-host:
        required: false
        type: string
        default: "docker.io"
      cr-login:
        required: false
        type: string
        default: "providus"
      build-context:
        required: false
        type: string
        default: "."
      dockerfile:
        required: false
        type: string
        default: "Dockerfile"
      image-name:
        required: true
        type: string
      argocd-host:
        required: true
        type: string
      argocd-version:
        required: false
        type: string
        default: "2.14.11"
      tenant:
        required: true
        type: string
      app-name:
        required: true
        type: string
      env-name:
        required: false
        type: string
        default: "dev"
      runner-label:
        required: false
        type: string
        default: "ubuntu-24.04"
    secrets:
      cr-pass:
        required: true
      argocd-token:
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: true

jobs:

  prepare:
    runs-on: ${{ inputs.runner-label }}
    outputs:
      sha_short: ${{ steps.prepare.outputs.sha_short }}
      app_version: ${{ steps.prepare.outputs.version }}
    steps:
      - uses: actions/checkout@v5

      - name: Prepare
        id: prepare
        shell: bash
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

          if ls ${{ inputs.build-context }}/package.json >/dev/null 2>&1; then
            echo "version=$(jq --raw-output .version ${{ inputs.build-context }}/package.json)" >> $GITHUB_OUTPUT
          elif ls ${{ inputs.build-context }}/pom.xml >/dev/null 2>&1; then
            sudo apt-get -y -qq install xq
            echo "version=$(cat ${{ inputs.build-context }}/pom.xml|xq -x /project/version)" >> $GITHUB_OUTPUT
          else
            echo "version=0.0.0" >> $GITHUB_OUTPUT
          fi

  build:
    runs-on: ${{ inputs.runner-label }}
    needs: [prepare]
    outputs:
      image_tag: ${{ needs.prepare.outputs.app_version }}-${{ needs.prepare.outputs.sha_short }}
    steps:

      - uses: actions/checkout@v5

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ inputs.cr-host }}
          username: ${{ inputs.cr-login }}
          password: ${{ secrets.cr-pass }}

      - uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.build-context }}
          file: ${{ inputs.dockerfile }}
          push: true
          tags: ${{ inputs.cr-host }}/${{ inputs.image-name }}:${{ needs.build.outputs.image_tag }}
          platforms: linux/amd64

  deploy:
    runs-on: ${{ inputs.runner-label }}
    needs: [prepare, build]
    steps:

      - name: Deploy to ArgoCD
        shell: bash
        env:
          ARGOCD_SERVER: ${{ inputs.argocd-host }}
          ARGOCD_AUTH_TOKEN: ${{ secrets.argocd-token }}
          ARGOCD_OPTS: "--grpc-web"
        run: |
          set +e

          echo "Installing ArgoCD CLI..."
          curl -sSLO https://github.com/argoproj/argo-cd/releases/download/v${{ inputs.argocd-version }}/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd

          echo "Listing applications..."
          apps=$(argocd app list -o name | grep "${{ inputs.tenant }}--${{ inputs.app-name }}--${{ inputs.env-name }}" || true)

          if [ -z "$apps" ]; then
            echo "‚ùå No matching applications found."
            exit 1
          fi

          updated=0

          for app in $(echo "$apps" | awk -F/ '{print $2}'); do
            echo "üöÄ Updating $app"
            argocd app set "$app" -p image.tag=${{ needs.build.outputs.image_tag }}
            if [ $? -eq 0 ]; then
              updated=$((updated+1))
            else
              echo "‚ö†Ô∏è Failed updating $app ‚Äî continuing..."
            fi
          done

          if [ $updated -eq 0 ]; then
            echo "‚ùå No applications were successfully updated."
            exit 1
          fi

          echo "‚úÖ Successfully updated $updated application(s)."
